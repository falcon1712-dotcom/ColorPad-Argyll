import { BusinessError } from '@kit.BasicServicesKit';

// –î–µ–∫–ª–∞—Ä–∞—Ü–∏—è –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –º–æ–¥—É–ª—è (Node-API)
const napi = require('libargyll.so');

@Entry
@Component
struct IndexPage {
  @State deviceFound: boolean = false;
  @State logs: string = '1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ i1Pro3 —á–µ—Ä–µ–∑ —Ö–∞–±\n2. –ù–∞–∂–º–∏—Ç–µ ¬´Scan USB¬ª';
  @State isMeasuring: boolean = false;

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ UI
  private log(msg: string) {
    this.logs += '\n' + msg;
  }

  build() {
    Column({ space: 12 }) {
      Text('ColorPad Argyll v0.1')
        .fontSize(20).fontWeight(FontWeight.Bold).margin(16);

      // –ö–Ω–æ–ø–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è USB
      Button('üîç Scan USB')
        .width('90%')
        .onClick(() => this.scanUSB());

      // –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø. –∫–Ω–æ–ø–∫–∏
      if (this.deviceFound) {
        Button('‚ö™ Calibrate white tile')
          .width('90%')
          .onClick(() => this.calibrate());
        
        Button('üé® Measure chart')
          .width('90%')
          .backgroundColor(this.isMeasuring ? Color.Green : Color.Blue)
          .onClick(() => this.measureChart());
        
        Button('üìä Build profile')
          .width('90%')
          .onClick(() => this.buildProfile());
      }

      // –õ–æ–≥-–æ–∫–Ω–æ (–ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–æ–µ)
      Scroll() {
        Text(this.logs)
          .fontSize(11)
          .fontFamily('monospace')
          .padding(8)
          .backgroundColor('#f0f0f0')
          .width('100%')
      }
      .height('60%')
      .border({ width: 1, color: '#ccc' });
    }
    .width('100%')
    .height('100%')
    .padding(12);
  }

  // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ USB (–≤—ã–∑–æ–≤ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ lsusb —á–µ—Ä–µ–∑ napi)
  private scanUSB() {
    this.logs = 'Scanning...';
    try {
      const result = napi.runArgyll('lsusb | grep 0765');
      if (result.includes('0765:6009')) {
        this.deviceFound = true;
        this.log('‚úì i1Pro3 Plus –Ω–∞–π–¥–µ–Ω (VID 0765, PID 6009)');
      } else {
        this.log('‚úó –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
      }
    } catch (e) {
      this.log('–û—à–∏–±–∫–∞: ' + (e as BusinessError).message);
    }
  }

  // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –±–µ–ª–æ–π –ø–ª–∏—Ç–∫–∏
  private calibrate() {
    this.log('‚Üí –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞: –ø–æ–ª–æ–∂–∏—Ç–µ i1Pro3 –Ω–∞ –±–µ–ª—É—é –ø–ª–∏—Ç–∫—É...');
    const result = napi.runArgyll('/data/argyll/ccxxmake -X -A i1pro3 -C -c "i1Pro3"');
    this.log(result);
    this.log('‚úì –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, .ccss —Å–æ–∑–¥–∞–Ω');
  }

  // –ò–∑–º–µ—Ä–µ–Ω–∏–µ —Ç–µ—Å—Ç-—á–∞—Ä—Ç–∞
  private measureChart() {
    this.isMeasuring = true;
    this.log('‚Üí –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø–∞—Ç—á–µ–π, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...');
    // –ü—Ä–∏–º–µ—Ä: —á–∏—Ç–∞–µ–º –≥–æ—Ç–æ–≤—ã–π chart.ti1 (–µ–≥–æ –Ω—É–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å –≤ resources)
    const result = napi.runArgyll('/data/argyll/chartread -v -H -T0.4 /data/argyll/chart.ti1');
    this.log(result);
    this.isMeasuring = false;
    this.log('‚úì –ò–∑–º–µ—Ä–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, chart.ti3 —Å–æ–∑–¥–∞–Ω');
  }

  // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
  private buildProfile() {
    this.log('‚Üí –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ ICC-–ø—Ä–æ—Ñ–∏–ª—è...');
    const result = napi.runArgyll('/data/argyll/colprof -v -D"MatePad_RGB" -q m -a m -n c chart.ti3');
    this.log(result);
    this.log('‚úì –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω: /Download/MatePad_RGB.icc');
  }
}