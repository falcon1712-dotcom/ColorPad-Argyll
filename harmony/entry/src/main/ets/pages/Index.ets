import libargyll from 'libargyll.so';

@Entry
@Component
struct IndexPage {
  @State deviceFound: boolean = false;
  @State logs: string = '1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ i1Pro3\n2. –ù–∞–∂–º–∏—Ç–µ ¬´Scan¬ª';

  build() {
    Column({ space: 12 }) {
      Text('ColorPad Argyll v0.1').fontSize(20).fontWeight(FontWeight.Bold).margin(16);
      Button('üîç Scan USB').width('90%').onClick(() => this.scanUSB());
      
      if (this.deviceFound) {
        Button('‚ö™ Calibrate').width('90%').onClick(() => this.calibrate());
        Button('üé® Measure').width('90%').onClick(() => this.measure());
      }

      Scroll() {
        Text(this.logs).fontSize(11).fontFamily('monospace').padding(8).backgroundColor('#f0f0f0').width('100%')
      }.height('60%').border({ width: 1, color: '#ccc' });
    }.width('100%').height('100%').padding(12);
  }

  private scanUSB() {
    this.logs = 'Scanning...';
    try {
      const result = libargyll.runArgyll('lsusb | grep 0765');
      this.deviceFound = result.includes('0765:6009');
      this.logs = this.deviceFound ? '‚úì i1Pro3 –Ω–∞–π–¥–µ–Ω' : '‚úó –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
    } catch (e) {
      this.logs = '–û—à–∏–±–∫–∞: ' + e.message;
    }
  }

  private calibrate() {
    this.logs = '–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞...';
    const result = libargyll.runArgyll('ccxxmake -X');
    this.logs = result;
  }

  private measure() {
    this.logs = '–ò–∑–º–µ—Ä–µ–Ω–∏–µ...';
    const result = libargyll.runArgyll('chartread -v chart.ti1');
    this.logs = result;
  }
}