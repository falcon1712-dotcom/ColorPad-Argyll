import libargyll from 'libargyll.so';

@Entry
@Component
struct IndexPage {
  @State deviceFound: boolean = false;
  @State logs: string = '1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ i1Pro3 —á–µ—Ä–µ–∑ —Ö–∞–±\n2. –ù–∞–∂–º–∏—Ç–µ ¬´Scan USB¬ª';
  @State isMeasuring: boolean = false;

  private log(msg: string) {
    this.logs += '\n' + msg;
  }

  build() {
    Column({ space: 12 }) {
      Text('ColorPad Argyll v0.1').fontSize(20).fontWeight(FontWeight.Bold).margin(16);
      Button('üîç Scan USB').width('90%').onClick(() => this.scanUSB());
      
      if (this.deviceFound) {
        Button('‚ö™ Calibrate').width('90%').onClick(() => this.calibrate());
        Button('üé® Measure').width('90%').backgroundColor(this.isMeasuring ? Color.Green : Color.Blue).onClick(() => this.measureChart());
        Button('üìä Build profile').width('90%').onClick(() => this.buildProfile());
      }

      Scroll() {
        Text(this.logs).fontSize(11).fontFamily('monospace').padding(8).backgroundColor('#f0f0f0').width('100%')
      }.height('60%').border({ width: 1, color: '#ccc' });
    }
    .width('100%').height('100%').padding(12);
  }

  private scanUSB() {
    this.logs = 'Scanning...';
    try {
      const result = libargyll.runArgyll('lsusb | grep 0765');
      if (result.includes('0765:6009')) {
        this.deviceFound = true;
        this.log('‚úì i1Pro3 Plus –Ω–∞–π–¥–µ–Ω');
      } else this.log('‚úó –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ');
    } catch (e) {
      this.log('–û—à–∏–±–∫–∞: ' + e.message);
    }
  }

  private calibrate() {
    this.log('‚Üí –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –±–µ–ª–æ–π –ø–ª–∏—Ç–∫–∏...');
    const result = libargyll.runArgyll('/data/argyll/ccxxmake -X -A i1pro3');
    this.log(result);
    this.log('‚úì –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  }

  private measureChart() {
    this.isMeasuring = true;
    this.log('‚Üí –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø–∞—Ç—á–µ–π...');
    const result = libargyll.runArgyll('/data/argyll/chartread -v -H chart.ti1');
    this.log(result);
    this.isMeasuring = false;
    this.log('‚úì –ò–∑–º–µ—Ä–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
  }

  private buildProfile() {
    this.log('‚Üí –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è...');
    const result = libargyll.runArgyll('/data/argyll/colprof -v -D"MatePad" -q m chart.ti3');
    this.log(result);
    this.log('‚úì –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω');
  }
}